{"componentChunkName":"component---src-templates-blog-post-js","path":"/nextjs-4/","result":{"data":{"site":{"siteMetadata":{"title":"공자윤의 기술블로그"}},"markdownRemark":{"id":"de6a80b3-4f73-5ee9-91b9-fb24a2482599","excerpt":"이번 포스팅에서는 공통 핸들러 처리에 대해 정리해 보도록 하겠습니다. 이전 포스트에서도 언급했듯이 현재 인증은 jwt 방식을 사용하고 있기 때문에 우선 공통적으로 토큰을 핸들링하는 과정이 필요했습니다.\n또한 V 컬러링은 APP 여부 및 OS…","html":"<p>이번 포스팅에서는 공통 핸들러 처리에 대해 정리해 보도록 하겠습니다.</p>\n<p>이전 포스트에서도 언급했듯이 현재 인증은 jwt 방식을 사용하고 있기 때문에 우선 공통적으로 <strong>토큰</strong>을 핸들링하는 과정이 필요했습니다.\n또한 V 컬러링은 APP 여부 및 OS 등의 정보에 종속되는 기능이 많기 때문에 <strong>userAgent</strong> 관리 또한 필요했습니다.</p>\n<p>토큰 같은 경우 기존에는 쉽게 로컬스토리지에 저장했다가 꺼내 쓰면 되고 userAgent는 <code class=\"language-text\">window</code> 객체로부터 손쉽게 가져올 수 있었지만, 개편된 구조에서는 SSR과 CSR 방식 모두에서 사용해야 했기 때문에 많은 고민이 필요했습니다.\n토큰은 쿠키에 저장하긴 했지만 SSR과 CSR에서 가져오는 방식이 다르고, userAgent 역시 SSR인 경우 <code class=\"language-text\">window</code> 객체에 접근할 수 없기 때문에 <code class=\"language-text\">getServerSideProps</code>에서 넘어오는 context의 req 내부의 header 정보에서 가져와야 합니다.</p>\n<p>고민 끝에 다음과 같이 도식화하였습니다. <del>(아날로그를 좋아하는 저는 아직 공책에 그림을 그립니다.)</del></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3a395bba6ed446a9272c7537c96f3a83/6d3de/architecture.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 164.55696202531647%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAhABQDASIAAhEBAxEB/8QAGQAAAwEBAQAAAAAAAAAAAAAAAAEDBAIF/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAH/2gAMAwEAAhADEAAAAfRc6IxhnU4rqM4cxCLgH//EABsQAAICAwEAAAAAAAAAAAAAAAAQARECAxMy/9oACAEBAAEFAnEvE6HQui1s84L/xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAEDAQE/AV//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/AV//xAAUEAEAAAAAAAAAAAAAAAAAAAAw/9oACAEBAAY/An//xAAbEAADAAIDAAAAAAAAAAAAAAAAAREQISAxcf/aAAgBAQABPyGiuHPPccOQ8E7s2dReA//aAAwDAQACAAMAAAAQ9BMw+C//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAEDAQE/EF//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/EF//xAAbEAEBAQADAQEAAAAAAAAAAAABABEhMWFRcf/aAAgBAQABPxDX1ktXcmYBZ0fHyyXL8mXH53DyZVuvbLJo+xwu26sdX//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"architecture\"\n        title=\"\"\n        src=\"/static/3a395bba6ed446a9272c7537c96f3a83/828fb/architecture.jpg\"\n        srcset=\"/static/3a395bba6ed446a9272c7537c96f3a83/ff44c/architecture.jpg 158w,\n/static/3a395bba6ed446a9272c7537c96f3a83/a6688/architecture.jpg 315w,\n/static/3a395bba6ed446a9272c7537c96f3a83/828fb/architecture.jpg 630w,\n/static/3a395bba6ed446a9272c7537c96f3a83/0ede0/architecture.jpg 945w,\n/static/3a395bba6ed446a9272c7537c96f3a83/3ac88/architecture.jpg 1260w,\n/static/3a395bba6ed446a9272c7537c96f3a83/6d3de/architecture.jpg 2446w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>서버 사이드 렌더링 시 데이터를 fetching할 경우 매번 토큰을 세팅하는 것이 번거로워, 우선 토큰 공통 처리를 하는 것부터 시작하였습니다.\n처음에는 단순히 header의 config 정보에서 토큰을 처리하면 된다고 생각하여 axios instance에서 토큰 정보를 불러와서 다음과 같이 바로 세팅하는 방법을 사용하였습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// my.tsx</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token literal-property property\">getServerSideProps</span><span class=\"token operator\">:</span> <span class=\"token function-variable function\">GetServerSideProps</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> req <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> queryClient <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">QueryClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token comment\">// 쿠키에서 토큰 정보를 추출한 뒤 header의 Authorization에 추가해 줍니다.</span>\n  <span class=\"token keyword\">const</span> token <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>cookies<span class=\"token punctuation\">.</span>token<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    axios<span class=\"token punctuation\">.</span>defaults<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'Authorization'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Bearer </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>token<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\t<span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// axiosInstance.ts</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getToken</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> auth <span class=\"token operator\">=</span> axios<span class=\"token punctuation\">.</span>defaults<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">.</span>Authorization<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 디폴트 헤더 값을 먼저 가져옴</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>auth<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> auth<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> token <span class=\"token operator\">=</span> Token<span class=\"token punctuation\">.</span><span class=\"token function\">getToken</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 없는 경우에 쿠키에서 직접 가져옴</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Bearer </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>token<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 요청 인터셉터</span>\ninstance<span class=\"token punctuation\">.</span>interceptors<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>\n  <span class=\"token punctuation\">(</span><span class=\"token parameter\">config</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 요청 전에 수행할 작업</span>\n    <span class=\"token keyword\">const</span> token <span class=\"token operator\">=</span> <span class=\"token function\">getToken</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>token <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>config<span class=\"token punctuation\">.</span>url<span class=\"token operator\">?.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span><span class=\"token string\">'oauth'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      config<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">.</span>Authorization <span class=\"token operator\">=</span> token<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> config<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 요청 오류 처리</span>\n    <span class=\"token keyword\">return</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>하지만 이렇게 하니 매번 페이지에서 토큰을 추출하여 axios의 header에 직접 박아 주거나, 아니면 req 정보를 axios에서 가지고 있어야 하는 번거로움이 있있습니다.\n<strong>페이지에서는 axios의 header에 접근할 필요가 없어야 하고, 또 API 핸들러에서는 토큰 정보를 가지고 있지 않도록 했으면 좋겠다</strong>는 것이 설계의 가장 큰 목표였습니다.</p>\n<p><code class=\"language-text\">getServerSideProps</code>에서 받아 오는 req 정보를 어디선가 처리하고 싶다는 생각을 하던 즈음 일단 다음 단계로 넘어가 보기로 하였습니다.\nV 컬러링 API 호출 시 요청 header에 넣어야 하는 고유값 중에 APP과 mWeb의 구분이 반드시 필요한 값이 있는데, 이를 위해서는 userAgent 정보를 가져와야 합니다.\nuserAgent의 값도 앞에서 언급한 것처럼 req의 headers 정보로부터 받아올 수 있습니다.</p>\n<p>req 정보로부터 받아온 쿠키(토큰) 값과 헤더(userAgent) 값을 한번에 처리하면 좋겠다는 생각이 들어 RequestHandler를 구현하였습니다.\n여기서는 단순히 req 값의 정보를 세팅하고 리턴하는 작업을 수행합니다.\n그리고 공통 페이지인 <code class=\"language-text\">_app.tsx</code>에서 RequestHandler를 호출하여 토큰과 userAgent 값을 세팅하였습니다.</p>\n<p>여기서 받아온 토큰 값과 userAgent 값을 모두 API 핸들러에서 사용해야 하기 때문에(헤더에 저장), 렌더링 방식에 따라 값을 리턴해주는 TokenHelper와 UserAgentHelper를 구현하였습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">TokenHelper</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">RequestHandler</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token function\">getToken</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">getServerToken</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> Cookies<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'token'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">UserAgentHelper</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">RequestHandler</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token function\">getUserAgent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">getServerUserAgent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> window<span class=\"token punctuation\">.</span>navigator<span class=\"token punctuation\">.</span>userAgent<span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>RequestHandler에서 가져온 토큰/userAgent 값이 있을 경우 (SSR) 해당 토큰 또는 userAgent를, 없을 경우 토큰은 쿠키의 토큰을 가져오고 userAgent는 <code class=\"language-text\">window</code>의 값을 가져오도록 처리하였습니다.</p>\n<p>OS 정보를 가져오는 EnvChecker에서도 userAgent 값이 필수이기 때문에 위의 UserAgentHelper를 사용하도록 구현하였습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">EnvChecker</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">UserAgentHelper</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token function\">isAndroid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">android</span><span class=\"token regex-delimiter\">/</span><span class=\"token regex-flags\">i</span></span><span class=\"token punctuation\">.</span><span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">getUserAgent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이제 API 핸들러에서 config 정보를 세팅하기 위해 토큰과 OS 정보를 가져오면 됩니다. axios의 instance를 관리하는 부분에서 다음과 같이 EnvChecker와 TokenHelper를 호출하였습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> getConfig <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token parameter\">AxiosRequestConfig</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> deviceInfo <span class=\"token operator\">=</span> EnvChecker<span class=\"token punctuation\">.</span><span class=\"token function\">getDeviceInfo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> isApp <span class=\"token operator\">=</span> EnvChecker<span class=\"token punctuation\">.</span><span class=\"token function\">isApp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> token <span class=\"token operator\">=</span> TokenHelper<span class=\"token punctuation\">.</span><span class=\"token function\">getToken</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">headers</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token string-property property\">'Content-Type'</span><span class=\"token operator\">:</span> <span class=\"token string\">'application/json'</span><span class=\"token punctuation\">,</span>\n\t\t  <span class=\"token operator\">...</span>\n      <span class=\"token operator\">...</span><span class=\"token punctuation\">(</span>isApp\n        <span class=\"token operator\">?</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string-property property\">'...-APP-VERSION'</span><span class=\"token operator\">:</span> deviceInfo<span class=\"token punctuation\">.</span>appVersion<span class=\"token punctuation\">,</span>\n            <span class=\"token string-property property\">'...-MODEL-NAME'</span><span class=\"token operator\">:</span> deviceInfo<span class=\"token punctuation\">.</span>deviceModel<span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token operator\">...</span><span class=\"token punctuation\">(</span>token <span class=\"token operator\">?</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">Authorization</span><span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Bearer </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>token<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span> <span class=\"token punctuation\">}</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">as</span> Record<span class=\"token operator\">&lt;</span>string<span class=\"token punctuation\">,</span> string<span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">timeout</span><span class=\"token operator\">:</span> <span class=\"token constant\">DEFAULT_TIMEOUT</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>위와 같이 axios의 instance에서 공통 처리를 하였기 때문에 API 호출부에서는 토큰 및 환경에 대한 어떤 관여도 없이 순수하게 API 호출만을 담당하도록 하였습니다.</p>\n<p>최종적으로 <code class=\"language-text\">_app.tsx</code>에서 initialize를 해 주었습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">App<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">getInitialProps</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> Component<span class=\"token punctuation\">,</span> pageProps<span class=\"token punctuation\">,</span> ctx <span class=\"token punctuation\">}</span><span class=\"token operator\">:</span> any</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\tRequestHandler<span class=\"token punctuation\">.</span><span class=\"token function\">setServerToken</span><span class=\"token punctuation\">(</span>cookies<span class=\"token operator\">?.</span>token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  RequestHandler<span class=\"token punctuation\">.</span><span class=\"token function\">setServerAgent</span><span class=\"token punctuation\">(</span>headers <span class=\"token operator\">?</span> headers<span class=\"token punctuation\">[</span><span class=\"token string\">'user-agent'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">:</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>SSR과 CSR 환경에서 모든 정보를 잘 가져오는 것을 확인할 수 있었습니다.</p>\n<h3>이슈1</h3>\n<p>세션 정보를 가져오는 My 페이지에 진입했을 경우 아무 문제가 없었으나, Player 페이지에 진입했을 때 오류가 발생하였습니다.\nuser.ts에서 initialize가 되기 전에 API 핸들러가 호출된다는 내용이었는데, Player에서는 UserAPI를 호출하고 있지 않는 상태였기 때문에 이슈가 왜 발생하는지 의아했습니다.</p>\n<p>원인을 분석해 보니 Player 컴포넌트에서 부르고 있는 하위 컴포넌트에서 userInfo 정보를 가져오기 위해 UserAPI를 호출하고 있다는 사실을 확인했습니다.\n그런데 Player의 경우 순수 CSR 컴포넌트이기 때문에 <code class=\"language-text\">getServerSideProps</code>를 사용하지 않고 있었고, <code class=\"language-text\">_app.tsx</code>의 <code class=\"language-text\">getInitialProps</code>에서 리턴하는 props를 받지 못한 상태라 API 핸들러에서 사용하고자 하는 정보들을 가져오는 과정에서 오류가 발생한 것이었습니다.</p>\n<p>문제를 해결하기 위해 Player에서 getServerSideProps를 선언하여 props를 가져오도록 하였습니다.\n그리고 결정적으로 모든 페이지에서 userInfo를 가져와야 하기 때문에 <code class=\"language-text\">_app.tsx</code>에서 initialize를 해 주는 과정에 userInfo를 받아 오는 작업을 추가해 주었습니다.\n그리고 dehydratedState로 리턴하도록 처리하였습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">initialize</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token literal-property property\">ctx</span><span class=\"token operator\">:</span> any</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">req</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> cookies<span class=\"token punctuation\">,</span> headers <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> ctx\n\n  RequestHandler<span class=\"token punctuation\">.</span><span class=\"token function\">setServerToken</span><span class=\"token punctuation\">(</span>cookies<span class=\"token operator\">?.</span>token<span class=\"token punctuation\">)</span>\n  RequestHandler<span class=\"token punctuation\">.</span><span class=\"token function\">setServerAgent</span><span class=\"token punctuation\">(</span>headers <span class=\"token operator\">?</span> headers<span class=\"token punctuation\">[</span><span class=\"token string\">\"user-agent\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">:</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getQueryClientForUserInfo</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> queryClient <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">QueryClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">await</span> queryClient<span class=\"token punctuation\">.</span><span class=\"token function\">prefetchQuery</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>QueryKey<span class=\"token punctuation\">.</span><span class=\"token constant\">GET_USER_INFO</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> UserApi<span class=\"token punctuation\">.</span>getUserInfo<span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">return</span> queryClient\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">App</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> Component<span class=\"token punctuation\">,</span> pageProps <span class=\"token punctuation\">}</span><span class=\"token operator\">:</span> AppProps</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>queryClient<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">QueryClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span>QueryClientProvider client<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>queryClient<span class=\"token punctuation\">}</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>Hydrate state<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>pageProps<span class=\"token operator\">?.</span>dehydratedState<span class=\"token punctuation\">}</span><span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>Layout<span class=\"token operator\">></span>\n          <span class=\"token operator\">&lt;</span>ToastManager bind<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>ToastHelper<span class=\"token punctuation\">.</span>bind<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n          <span class=\"token operator\">&lt;</span>Component <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span>pageProps<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>Layout<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>Navigation router<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>router<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>Hydrate<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>QueryClientProvider<span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\nApp<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">getInitialProps</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> Component<span class=\"token punctuation\">,</span> pageProps<span class=\"token punctuation\">,</span> ctx <span class=\"token punctuation\">}</span><span class=\"token operator\">:</span> any</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">initialize</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">props</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">dehydratedState</span><span class=\"token operator\">:</span> <span class=\"token function\">dehydrate</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">await</span> <span class=\"token function\">getQueryClientForUserInfo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      Component<span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">pageProps</span><span class=\"token operator\">:</span> pageProps <span class=\"token operator\">||</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> App</code></pre></div>\n<p>이렇게 하면 각 페이지에서는 데이터를 따로 fetching하지 않아도 userInfo 값을 사용할 수 있게 됩니다.</p>\n<h3>이슈2</h3>\n<p>userAgent 값을 분기 처리할 때 <code class=\"language-text\">typeof window !== 'undefined'</code>라는 조건으로 CSR 여부를 판단하면 된다고 ChatGPT가 알려주었으나 실제로는 <code class=\"language-text\">window</code>를 찾을 수 없다는 오류가 계속해서 발생했습니다.\n그래서 <code class=\"language-text\">window</code>의 type으로 표시되는 <code class=\"language-text\">globalThis</code> 조건을 추가하였더니 이슈가 해결되었습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token function\">getUserAgent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">getServerAgent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token keyword\">typeof</span> globalThis\n    <span class=\"token operator\">?</span> <span class=\"token keyword\">typeof</span> window <span class=\"token operator\">!==</span> <span class=\"token string\">'undefined'</span>\n      <span class=\"token operator\">?</span> window<span class=\"token punctuation\">.</span>navigator<span class=\"token punctuation\">.</span>userAgent\n      <span class=\"token operator\">:</span> <span class=\"token string\">''</span>\n    <span class=\"token operator\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>이슈3</h3>\n<p>원래는 모든 클래스에서 static을 쓰지 않고 생성자를 따로 두어 new로 호출하려고 하였으나, 그렇게 하려면 모든 화면에서 req 정보를 가지고 있어야 한다는 번거로움이 있었습니다.\n그리고 무엇보다도 API나 EnvChecker를 호출할 때마다 new로 생성을 해 주어야 해서 코드가 지저분해지는 느낌이 있어 static으로 변경하여 사용하도록 처리하였습니다.</p>\n<p>다음 포스팅에서는 레이어 처리 과정 및 결과를 정리할 예정입니다.</p>","frontmatter":{"title":"V 컬러링에 Next.js 도입하기 (4)","date":"March 29, 2023","description":"React로 구현된 SPA (CSR) 프로젝트를 Next.js로 Migration하는 과정","author":"jayoon"}},"previous":{"fields":{"slug":"/nextjs-3/"},"frontmatter":{"title":"V 컬러링에 Next.js 도입하기 (3)"}},"next":null},"pageContext":{"id":"de6a80b3-4f73-5ee9-91b9-fb24a2482599","previousPostId":"34b278df-356c-57e4-98c7-ec93fa6afc32","nextPostId":null}},"staticQueryHashes":["2841359383"],"slicesMap":{}}