---
title: "V ì»¬ëŸ¬ë§ì— React Query ë„ì…í•˜ê¸°"
date: "2022-04-28"
tags: ["Vì»¬ëŸ¬ë§", "React Query", "react-query"]
author: "jayoon"
description: "ë¦¬ë•ìŠ¤ì—ì„œ react queryë¡œ ì „í™˜í•œ ê³¼ì • ì†Œê°œ. react query ì „í™˜ ë° ë„ì… ê³¼ì •"
---

[ì´ì „ í¬ìŠ¤íŠ¸](https://jayoon-kong.github.io/swr-react_query/)ì—ì„œë„ ì–¸ê¸‰í–ˆë“¯ì´ í˜„ì¬ V ì»¬ëŸ¬ë§ì˜ APIëŠ” ì¡°íšŒì„±ì„ì—ë„ ë¶ˆêµ¬í•˜ê³  POST ë©”ì†Œë“œê°€ ëŒ€ë¶€ë¶„ì…ë‹ˆë‹¤. ê°€ë³ê²Œ ë„ì…í•  ìˆ˜ ìˆëŠ” SWRë„ ë§¤ë ¥ì ì´ì§€ë§Œ React Queryë¥¼ ë„ì…í•˜ê¸°ë¡œ ê²°ì •í•œ ê°€ì¥ í° ì´ìœ ì…ë‹ˆë‹¤. ê·¸ë¦¬ê³  ë¦¬ì„œì¹˜ë¥¼ í•˜ë‹¤ ë³´ë‹ˆ React Queryê°€ ì•„ë¬´ë˜ë„ ì¸ê¸°ë„ ë§ê³  referenceë„ ë§ì•„ ì‹¤ì œë¡œ ì ìš©í•˜ê¸°ì—ë„ ì¢‹ì„ ê²ƒ ê°™ì•˜ìŠµë‹ˆë‹¤.

ìš°ì„  ì–´ë–¤ ë¶€ë¶„ì— React Queryë¥¼ ì ìš©í• ì§€ì— ëŒ€í•œ ê³ ë¯¼ì„ ê°€ì¥ ë¨¼ì € ì‹œì‘í–ˆìŠµë‹ˆë‹¤. ìºì‹± ì²˜ë¦¬ì™€ ìë™ ê°±ì‹ , ê·¸ë¦¬ê³  ê¸°ì¡´ ì½”ë“œ ëŒ€ë¹„ ê°€ì¥ ë‘ë“œëŸ¬ì§„ ì°¨ì´ë¥¼ ëŠë‚„ ìˆ˜ ìˆëŠ” ë¶€ë¶„ì´ ë­˜ê¹Œ ê³ ë¯¼í•´ ë³´ë‹ˆ ë‹¨ì—° User ì •ë³´ê°€ ì œì¼ ë¨¼ì € ë– ì˜¤ë¥´ë”êµ°ìš”. ì‚¬ì‹¤ ë°°í¬ í›„ ì‚¬ìš©ìê°€ ìƒˆë¡œê³ ì¹¨ì„ í•˜ì§€ ì•Šìœ¼ë©´ ìºì‹œ ë¬¸ì œ ë•Œë¬¸ì— ê°„í˜¹ ë¸Œë¼ìš°ì €ì—ì„œ ì˜ˆì „ ì½”ë“œë¥¼ ì¸ì‹í•˜ëŠ” ê²½ìš°ê°€ ì¢…ì¢… ìˆì—ˆëŠ”ë°, V ì»¬ëŸ¬ë§ì€ ì‘ë…„ í•˜ë°˜ê¸° ID íšŒì›ì²´ê³„ ê°œí¸ì„ í†µí•´ ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” API ì¤‘ ìƒë‹¹ìˆ˜ê°€ v2 ë²„ì „ìœ¼ë¡œ ë³€ê²½ëœ ë°” ìˆìŠµë‹ˆë‹¤. ê·¸ë˜ì„œ ìœ„ì™€ ê°™ì€ ì¼ì´ ë°œìƒí•˜ë©´ íšŒì›ê°€ì…ì´ ì œëŒ€ë¡œ ë˜ì§€ ì•Šê±°ë‚˜ í˜¹ì€ ì‚¬ìš©ì ì •ë³´ë¥¼ ì œëŒ€ë¡œ ê°€ì ¸ì˜¤ì§€ ëª»í•˜ëŠ” ë“±ì˜ ë¬¸ì œê°€ ìƒê¸°ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤. V ì»¬ëŸ¬ë§ ê°™ì€ ê²½ìš° ì•±ì„ í†µí•´ ê°€ì…í•˜ëŠ” ì‚¬ìš©ìë„ ë§ê³  (ì•±ì€ ë¡œê·¸ì¸ ì²˜ë¦¬ê°€ ë‹¤ë¦„) ì‚¬ìš©ìê°€ ì‚¬ì‹¤ ì•„ì£¼ ë§ì€ ì¼€ì´ìŠ¤ëŠ” ì•„ë‹ˆì§€ë§Œ, ê·¸ë˜ë„ ëª¨ë‘ê°€ ì´ìš©í•  ìˆ˜ ìˆëŠ” ëŒ€êµ­ë¯¼ ì„œë¹„ìŠ¤ì¸ ë§Œí¼ ê¼­ í•´ê²°í•´ì•¼ë§Œ í•˜ëŠ” ì‹¬ê°í•œ ë¬¸ì œì˜€ì£ . React Queryë¥¼ ë„ì…í•˜ë©´ ì´ëŸ¬í•œ ë¬¸ì œê°€ í•´ê²°ë  ê²ƒì´ë¼ ê¸°ëŒ€í•´ ë´…ë‹ˆë‹¤.

ë¨¼ì € ë²”ìš©ì ìœ¼ë¡œ ì‚¬ìš©ë˜ê³  ìˆëŠ” Reduxë¥¼ ê±·ì–´ë‚´ê¸° ì „ì— ì „ì²´ì ì¸ êµ¬ì¡°ë¥¼ ë¨¼ì € ì‚´í´ë³´ì•˜ìŠµë‹ˆë‹¤. í˜„ì¬ User ì •ë³´ê°€ ë³€ê²½ë˜ëŠ” êµ¬ê°„ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

> 1. íšŒì›ê°€ì…
> 2. ë¡œê·¸ì¸
> 3. í”„ë¡œí•„ ë³€ê²½
> 4. ë¶€ê°€ì„œë¹„ìŠ¤ ê°€ì… ë° í•´ì§€
> 5. íšŒì›íƒˆí‡´

í˜„ì¬ ìœ„ì˜ ë‹¤ì„¯ ê°€ì§€ ê²½ìš°ì— User ì •ë³´ë¥¼ ê°±ì‹ í•˜ëŠ” APIë¥¼ í˜¸ì¶œí•˜ê³ , ê·¸ ì§í›„ì— ë³€ê²½ëœ User ì •ë³´ë¥¼ ì„œë²„ë¡œë¶€í„° ë‚´ë ¤ë°›ì•„ Redux Storeì— ì—…ë°ì´íŠ¸í•´ ì¤ë‹ˆë‹¤. ê·¸ëŸ¬ë©´ User ì •ë³´ë¥¼ ë°›ì•„ ì˜¤ëŠ” ìˆ˜ë§ì€ í™”ë©´ì—ì„œ `dispatch(getUser())`ë¥¼ í†µí•´ ìë™ìœ¼ë¡œ ê°±ì‹ ëœ ì •ë³´ë¥¼ ë°›ì•„ ì˜¤ê²Œ ë©ë‹ˆë‹¤. ë³¸ í¬ìŠ¤íŠ¸ì—ì„œëŠ” 1ì°¨ ëª©í‘œë¡œ ì‚¬ìš©ì ì •ë³´ì˜ ê°±ì‹ ê³¼ ì¡°íšŒë¥¼ í•˜ëŠ” í”„ë¡œì„¸ìŠ¤ì— React Queryë¥¼ ë„ì…í•˜ê³ , ê·¸ ê³¼ì • ë° ê²°ê³¼ì™€ íŠ¸ëŸ¬ë¸” ìŠˆíŒ… ë“±ì„ ê¸°ë¡í•  ì˜ˆì •ì…ë‹ˆë‹¤.

```javascript
const queryClient = new QueryClient()

ReactDOM.render(
  <QueryClientProvider client={queryClient}>
    <Provider store={store}>
      <BrowserRouter>
        <ToastManager bind={ToastHelper.bind} />
        <PopupManager bind={PopupHelper.bind} />
        <App />
      </BrowserRouter>
    </Provider>
  </QueryClientProvider>,
  rootElement
)
```

ê¸°ì¡´ì— Providerë¡œ ê°ì‹¸ì ¸ ìˆë˜ ë©”ì¸ ì»´í¬ë„ŒíŠ¸ ìœ„ì— QueryClientProviderì„ ìµœìƒìœ„ ì»´í¬ë„ŒíŠ¸ë¡œ ê°ì‹¸ê³  QueryClient ê°’ì„ Propìœ¼ë¡œ ë„£ì—ˆìŠµë‹ˆë‹¤.

```javascript
const useUser = () => {
  const result = useQuery("getUser", async () => {
    const [res1, res2] = await Promise.all([
      UserApi.getUser(),
      UserApi.getUserInfo(),
    ])
    if (
      res1.code === StatusCodes.SUCCESS &&
      res2.code === StatusCodes.SUCCESS
    ) {
      return {
        user: res1.data,
        userInfo: res2.data,
      }
    }
    return null
  })
  return result
}
```

ë‹¤ìŒì€ ê°„ë‹¨í•˜ê²Œ useUserë¼ëŠ” hookì„ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ ì¸ìë¡œëŠ” user ì •ë³´ë¥¼ ê°€ì ¸ì˜¨ë‹¤ëŠ” ì˜ë¯¸ì˜ getUserì„ keyë¡œ ì‚¬ìš©í–ˆê³ , ë‘ ë²ˆì§¸ ì¸ì(fetcher)ëŠ” ì‹¤ì œë¡œ ì‚¬ìš©ì ì •ë³´ë¥¼ ë°›ì•„ ì˜¤ëŠ” promise í•¨ìˆ˜ë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.

ë‹¤ìŒìœ¼ë¡œëŠ” App.tsx ì»´í¬ë„ŒíŠ¸ì—ì„œ ê°„ë‹¨íˆ user ì •ë³´ë¥¼ ê°€ì ¸ì™€ ë³´ì•˜ìŠµë‹ˆë‹¤.

```javascript
const { data } = useUser()
console.log("app", data?.user)
```

![console](./console.png)

í™”ë©´ì„ ì „í™˜í•  ë•Œë§ˆë‹¤ ì´ë ‡ê²Œ ë°ì´í„°ê°€ ì˜ ì°íˆë„¤ìš”. ê·¼ë° ì¢€ ì´ìƒí•©ë‹ˆë‹¤. ì œê°€ ê¸°ëŒ€í•œ ê²ƒì€ ìºì‹œ ì²˜ë¦¬ë¼ ì›ë˜ ì´ë ‡ê²Œ APIê°€ ìì£¼ í˜¸ì¶œë˜ë©´ ì•ˆë  ê²ƒ ê°™ì€ë° ë„¤íŠ¸ì›Œí¬ íƒ­ì„ í™•ì¸í•´ ë³´ë©´ ì£¼ê¸°ì ìœ¼ë¡œ APIê°€ í˜¸ì¶œë˜ê³  ìˆë„¤ìš”. ì´ ë¶€ë¶„ì€ ì–´ë–¤ ì˜µì…˜ìœ¼ë¡œ í•´ê²°í•  ìˆ˜ ìˆì„ì§€ ì¢€ ë” ì°¾ì•„ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

![api_1](./api_1.png)

( v1/user/infoì™€ v1/user/profileì´ í™”ë©´ì´ ì „í™˜ë  ë•Œë§ˆë‹¤ ì°íˆê³  ìˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.)

### React Queryì—ì„œì˜ cache ì²˜ë¦¬

React Queryì—ì„œ ìºì‹œ ì²˜ë¦¬ì˜ ì›ë¦¬ë¥¼ ì•Œê¸° ìœ„í•´ì„œëŠ” staleTimeê³¼ cacheTimeì˜ ì°¨ì´ë¥¼ ì•Œì•„ì•¼ í•©ë‹ˆë‹¤. ê·¸ ì „ì— ìš°ì„  ë¼ì´í”„ ì‚¬ì´í´ì— ëŒ€í•œ ì´í•´ê°€ í•„ìš”í•œë°ìš”, A ì¿¼ë¦¬ ì¸ìŠ¤í„´ìŠ¤ê°€ mountë˜ë©´ ë°ì´í„°ê°€ fetchë˜ê³  useQueryì˜ ì²« ë²ˆì§¸ ì¸ìë¡œ ë„˜ê¸´ query keyë¡œ ìºì‹±ì„ í•©ë‹ˆë‹¤. ì´ ë°ì´í„°ëŠ” fresh ìƒíƒœì—ì„œ staleTime(ê¸°ë³¸ê°’ 0) ì´í›„ì— stale ìƒíƒœë¡œ ë³€ê²½ë˜ê³ , A ì¿¼ë¦¬ ì¸ìŠ¤í„´ìŠ¤ê°€ unmountë˜ëŠ” ì‹œì ë¶€í„° ìºì‹œëŠ” cacheTime(ê¸°ë³¸ê°’ 5)ë§Œí¼ ìœ ì§€ë˜ë‹¤ê°€ ê°€ë¹„ì§€ ì½œë ‰í„°ë¡œ ë„˜ê²¨ì§‘ë‹ˆë‹¤. ë§Œì¼ cacheTimeì´ ì§€ë‚˜ê¸° ì „ì— A ì¿¼ë¦¬ ì¸ìŠ¤í„´ìŠ¤ê°€ ìƒˆë¡­ê²Œ mountë˜ë©´, fetchê°€ ì‹¤í–‰ë˜ê³  freshí•œ ê°’ì„ ê°€ì ¸ì˜¤ëŠ” ë™ì•ˆ ìºì‹œëœ ë°ì´í„°ë¥¼ ë³´ì—¬ì£¼ê²Œ ë©ë‹ˆë‹¤.

ê·¸ëŸ¼ ì´ì œ staleTimeê³¼ cacheTimeì˜ ì°¨ì´ì ì„ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.

- **staleTime**
  - ë°ì´í„°ê°€ fresh ìƒíƒœì—ì„œ stale ìƒíƒœë¡œ ë³€ê²½ë˜ëŠ” ë° ê±¸ë¦¬ëŠ” ì‹œê°„
  - fresh ìƒíƒœì¼ ë•ŒëŠ” ì¿¼ë¦¬ ì¸ìŠ¤í„´ìŠ¤ê°€ ìƒˆë¡­ê²Œ mountë˜ì–´ë„ fetchê°€ ì¼ì–´ë‚˜ì§€ ì•ŠëŠ”ë‹¤.
  - ë°ì´í„°ê°€ í•œ ë²ˆ fetchë˜ê³  ë‚˜ì„œ staleTimeì´ ì§€ë‚˜ì§€ ì•Šì•˜ë‹¤ë©´ unmount í›„ mountë˜ì–´ë„ fetchê°€ ì¼ì–´ë‚˜ì§€ ì•ŠëŠ”ë‹¤.
- **cacheTime**
  - ë°ì´í„°ê°€ inactive ìƒíƒœì¼ ë•Œ ìºì‹±ëœ ìƒíƒœë¡œ ë‚¨ì•„ìˆëŠ” ì‹œê°„
  - ì¿¼ë¦¬ ì¸ìŠ¤í„´ìŠ¤ê°€ unmountë˜ë©´ inactive ìƒíƒœë¡œ ë³€ê²½ë˜ë©°, ìºì‹œëŠ” cacheTimeë§Œí¼ ìœ ì§€ëœë‹¤.
  - cacheTimeì´ ì§€ë‚˜ë©´ ê°€ë¹„ì§€ ì½œë ‰í„°ë¡œ ìˆ˜ì§‘ë˜ë©°, cacheTimeì´ ì§€ë‚˜ê¸° ì „ì— ì¿¼ë¦¬ ì¸ìŠ¤í„´ìŠ¤ê°€ ë‹¤ì‹œ mountë˜ë©´ ë°ì´í„°ë¥¼ fetchí•˜ëŠ” ë™ì•ˆ ìºì‹œ ë°ì´í„°ë¥¼ ë³´ì—¬ì¤€ë‹¤.

ì¦‰ ìœ„ì˜ ê²½ìš° data fetchê°€ ì¼ì–´ë‚˜ëŠ” ì´ìœ ëŠ” ìƒˆë¡œìš´ ì¿¼ë¦¬ ì¸ìŠ¤í„´ìŠ¤ê°€ Mountë˜ì—ˆê¸° ë•Œë¬¸(í˜ì´ì§€ ì´ë™ì´ ì¼ì–´ë‚¨)ì´ë¼ê³  ë³¼ ìˆ˜ ìˆëŠ”ë°ìš”, ê¸°ë³¸ì ìœ¼ë¡œ React Queryì— ì•„ë¬´ ì„¤ì •ì„ í•˜ì§€ ì•Šìœ¼ë©´ ìºì‹±ì´ ë˜ì§€ ì•ŠëŠ” ê²ƒì´ ì •ìƒì´ê¸° ë•Œë¬¸ì— ìœ„ì™€ ê°™ì€ í˜„ìƒì´ ì¼ì–´ë‚˜ê²Œ ëœ ê²ƒì…ë‹ˆë‹¤. ì‚¬ì‹¤ V ì»¬ëŸ¬ë§ì—ì„œëŠ” ëª¨ë“  í˜ì´ì§€ ì´ë™ ì‹œ ë¡œê·¸ì¸ ì—¬ë¶€ ë° ì •íšŒì›/ì¤€íšŒì› ì—¬ë¶€ë¥¼ ì²´í¬í•´ì•¼ í•˜ê¸° ë•Œë¬¸ì— ë§¤ë²ˆ ìµœì‹  ë°ì´í„°ë¡œ fetchë˜ì–´ì•¼ í•˜ëŠ” ê²ƒì´ ë§ìŠµë‹ˆë‹¤.

í•˜ì§€ë§Œ ë°ì´í„°ì˜ fetchê°€ ë§¤ë²ˆ í•„ìš”í•˜ì§€ ì•Šì€ ìƒí™©ì´ê±°ë‚˜, í˜¹ì€ ì´ë ‡ê²Œ ìì£¼ fetchí•˜ì§€ ì•Šê³  íŠ¹ì • ì‹œê°„ì´ ì§€ë‚œ ì´í›„ì—ë§Œ ì£¼ê¸°ì ìœ¼ë¡œ ë°ì´í„°ë¥¼ ê°±ì‹ í•˜ê³  ì‹¶ë‹¤ë©´ ì–´ë–»ê²Œ í•´ì•¼ í• ê¹Œìš”? ì´ ë•Œ ìœ„ì—ì„œ ì‚´í´ë³¸ staleTimeê³¼ caheTimeì˜ ì‚¬ìš©ì´ í•„ìš”í•©ë‹ˆë‹¤. ì´ ë‘ ê°’ì€ optionìœ¼ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```javascript
const useUser = () => {
  const result = useQuery(
    "getUser",
    async () => {
      const [res1, res2] = await Promise.all([
        UserApi.getUser(),
        UserApi.getUserInfo(),
      ])
      if (
        res1.code === StatusCodes.SUCCESS &&
        res2.code === StatusCodes.SUCCESS
      ) {
        return {
          user: res1.data,
          userInfo: res2.data,
        }
      }
      return null
    },
    {
      staleTime: 5000,
      cacheTime: Infinity,
    }
  )
  return result
}
```

User ì •ë³´ë¥¼ ë°›ì•„ ì˜¤ëŠ” ì¿¼ë¦¬ì— ìœ„ì™€ ê°™ì´ ì˜µì…˜ì„ ì¶”ê°€í•˜ì˜€ìŠµë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ staleTimeìœ¼ë¡œ ì„¤ì •í•œ ì‹œê°„ë§Œí¼ ë°ì´í„°ì˜ ì‹ ì„ ë„ê°€ ìœ ì§€ë˜ê³  (fresh ìƒíƒœ), ì´ ì‹œê°„ì´ ì§€ë‚˜ë©´ freshí•œ ìƒíƒœì—ì„œ staleí•œ ìƒíƒœê°€ ë˜ê¸° ë•Œë¬¸ì— ë‹¤ì‹œ fetchê°€ ì¼ì–´ë‚˜ê²Œ ë©ë‹ˆë‹¤.

![api_2](./api_2.png)

í˜„ì¬ ìœ„ì˜ App.tsxì™€ ë§ˆì°¬ê°€ì§€ë¡œ Player.tsxì™€ My.tsxì—ë„ í™”ë©´ ì§„ì… ì‹œ useUserë¥¼ í†µí•´ user ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ë„ë¡ êµ¬í˜„í•´ ë‘” ìƒíƒœì…ë‹ˆë‹¤. ìºì‹œ í…ŒìŠ¤íŠ¸ë¥¼ í•˜ê¸° ìœ„í•´ 5ì´ˆ ë™ì•ˆ player íƒ­ê³¼ my íƒ­ì„ ì—¬ëŸ¬ ë²ˆ ì™”ë‹¤ê°”ë‹¤ í–ˆëŠ”ë°ìš”, ìœ„ ë„¤íŠ¸ì›Œí¬ íƒ­ì—ì„œ ë³¼ ìˆ˜ ìˆë“¯ì´ v1/user/infoì™€ v1/user/profileì´ í™”ë©´ì´ ì „í™˜ë  ë•Œë§ˆë‹¤ ì°íˆëŠ” ê²ƒì´ ì•„ë‹ˆë¼ ê°„í—ì ìœ¼ë¡œ (ìœ„ì—ëŠ” í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤ë§Œ 5ì´ˆì— í•œ ë²ˆì”©!) ì°íˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. staleTimeì´ 5ì´ˆì´ê¸° ë•Œë¬¸ì— í•œ ë²ˆ fetchí•´ ì˜¨ user ì •ë³´ê°€ 5ì´ˆ ë™ì•ˆ freshí•œ ìƒíƒœë¡œ ìœ ì§€ë˜ì–´ ë‹¤ìŒ í˜¸ì¶œ ì‹œì—ëŠ” ìºì‹±ëœ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê³ , 5ì´ˆê°€ ì§€ë‚˜ë©´ staleí•œ ìƒíƒœë¡œ ë³€ê²½ë˜ê¸° ë•Œë¬¸ì— ë‹¤ì‹œ fetchë¥¼ í•´ì˜¤ê²Œ ë˜ëŠ” ê²ƒì´ì£ . (ìœ„ ì˜ˆì‹œëŠ” í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ ê²ƒì´ê³ , ì‹¤ì œë¡œ V ì»¬ëŸ¬ë§ì—ì„œëŠ” staleTimeì„ 30ë¶„ìœ¼ë¡œ ì§€ì •í•˜ì˜€ìŠµë‹ˆë‹¤.)

### refetchInterval, refetchOnWindowFocus, refetchOnReconnect

ì• í¬ìŠ¤íŒ…ì—ì„œ ì–¸ê¸‰í•œ ë°”ì™€ ê°™ì´ React Queryì—ì„œëŠ” ë¸Œë¼ìš°ì €ì— ë‹¤ì‹œ í¬ì»¤ìŠ¤ê°€ ëœ ê²½ìš°ë‚˜ ë„¤íŠ¸ì›Œí¬ê°€ ì¬ì—°ê²°ë˜ì—ˆì„ ë•Œ dataë¥¼ ìë™ ê°±ì‹ í•˜ëŠ” ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤. refetchOnWindowFocusì™€ refetchOnReconnectë¥¼ ì´ìš©í•˜ì—¬ í•´ë‹¹ ê¸°ëŠ¥ì„ on/offí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì‚¬ìš©ë²•ì€ ì•„ì£¼ ê°„ë‹¨í•©ë‹ˆë‹¤.

```javascript
const useUser = () => {
  const result = useQuery(
    "getUser",
    async () => {
      const [res1, res2] = await Promise.all([
        UserApi.getUser(),
        UserApi.getUserInfo(),
      ])
      if (
        res1.code === StatusCodes.SUCCESS &&
        res2.code === StatusCodes.SUCCESS
      ) {
        return {
          user: res1.data,
          userInfo: res2.data,
        }
      }
      return null
    },
    {
      staleTime: 5000,
      cacheTime: Infinity,
      refetchOnWindowFocus: true,
      refetchOnReconnect: true,
    }
  )
  return result
}
```

ì´ ë‘ ê°’ì˜ ê¸°ë³¸ê°’ì€ trueì´ë¯€ë¡œ ì‚¬ì‹¤ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ê³ ì í•  ë•Œì—ëŠ” êµ³ì´ ì˜µì…˜ìœ¼ë¡œ ë„£ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤. ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ê³  ì‹¶ì§€ ì•Šì€ ê²½ìš°ì—ëŠ” false ê°’ì„ ë„£ì–´ ì£¼ë©´ í•´ë‹¹ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê·¸ë¦¬ê³  refetchInterval ê°’ì„ í†µí•´ ê°±ì‹  íƒ€ì„ì„ ì„¤ì •í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. í´ë§ êµ¬í˜„ ì‹œ ìœ ìš©í•  ê²ƒ ê°™ìŠµë‹ˆë‹¤.

### useMutation

ìœ„ì™€ ê°™ì´ staleTimeìœ¼ë¡œ ë°˜ë³µì ì¸ API í˜¸ì¶œì„ ì œì–´í–ˆìŠµë‹ˆë‹¤. ê·¸ëŸ°ë° íšŒì› ê°€ì…ì´ë‚˜ ë¡œê·¸ì¸, íƒˆí‡´ ë“±ì˜ ì´ìœ ë¡œ ì‚¬ìš©ì ì •ë³´ê°€ ì¦‰ê°ì ìœ¼ë¡œ ë³€ê²½ë˜ì–´ì•¼ í•˜ëŠ” ê²½ìš°ì—ëŠ” ì–´ë–»ê²Œ í•´ì•¼ í• ê¹Œìš”? ë°ì´í„°ì˜ ìƒíƒœê°€ staleì´ ë  ë•Œê¹Œì§€(30ë¶„ì„) ë§ˆëƒ¥ ê¸°ë‹¤ë¦´ ìˆ˜ëŠ” ì—†ê² ì£ . ì´ëŸ° ê²½ìš°ì— useMutationì„ ì‚¬ìš©í•˜ì—¬ ë°ì´í„°ë¥¼ ì—…ë°ì´íŠ¸í•´ ì¤ë‹ˆë‹¤.

React Queryì—ì„œ ì œê³µí•˜ëŠ” useMutationì€ ì†ì‰½ê²Œ ë°ì´í„°ë¥¼ ì—…ë°ì´íŠ¸í•´ ì£¼ëŠ” ì¥ì ë„ ìˆì§€ë§Œ, ë¬´ë ¤ ì—…ë°ì´íŠ¸ í›„ ìœ„ì˜ useQueryì—ì„œ ì‚¬ìš©í–ˆë˜ get í•¨ìˆ˜ë¥¼ ìë™ìœ¼ë¡œ ì¬ì‹¤í–‰í•´ì£¼ëŠ” ì¥ì ë„ ìˆìŠµë‹ˆë‹¤. ì‚¬ìš©ë²•ì€ ì•„ì£¼ ê°„ë‹¨í•©ë‹ˆë‹¤. unique keyë¡œ ë§µí•‘ëœ get í•¨ìˆ˜ë¥¼ invalidateQueriesì— ë„£ì–´ì£¼ê¸°ë§Œ í•˜ë©´ ë©ë‹ˆë‹¤.

```javascript
const { mutate } = useMutation(async () => {
  const res = await UserApi.logout()
  if (res.code === StatusCodes.SUCCESS) {
    if (EnvChecker.isApp()) {
      NativeHelper.send(NativeActionTypes.LOGOUT)
    }
    queryClient.invalidateQueries("getUser")
  }
})
```

ìœ„ ì½”ë“œëŠ” ë¡œê·¸ì•„ì›ƒ ì˜ˆì‹œì¸ë°ìš”, ì´ë ‡ê²Œ êµ¬í˜„í•˜ê¸°ë§Œ í•˜ë©´ ë¡œê·¸ì•„ì›ƒ ì‹œ ìë™ìœ¼ë¡œ â€˜getUserâ€™ì— ë§µí•‘ëœ useUserë¥¼ ì‹¤í–‰í•˜ë©´ì„œ user ì •ë³´ë¥¼ ê°±ì‹ í•©ë‹ˆë‹¤.

ìœ„ ì˜ˆì œì—ì„œëŠ” ì„±ê³µí–ˆì„ ê²½ìš°ë¥¼ ë”°ë¡œ êµ¬í˜„í–ˆì§€ë§Œ, useMutationì—ì„œë„ í•¨ìˆ˜ ì‹¤í–‰ì´ ì„±ê³µí–ˆì„ ê²½ìš°ì˜ ì²˜ë¦¬ ë°©ë²•ì„ ì œê³µí•´ ì¤ë‹ˆë‹¤.

```javascript
const { mutate } = useMutation(() => UserApi.logout(), {
  onSuccess: () => {
    if (EnvChecker.isApp()) {
      NativeHelper.send(NativeActionTypes.LOGOUT)
    }
    queryClient.invalidateQueries("getUser")
  },
})
```

ì¡°ê¸ˆ ë” ê°€ë…ì„±ì´ ì¢‹ì•„ì§„ ê²ƒì„ ëŠë‚„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. :)

í•˜ì§€ë§Œ ì—¬ëŸ¬ ê³³ì—ì„œ ì‚¬ìš©í•˜ë ¤ë‹ˆ ì¤‘ë³µ ì½”ë“œê°€ ë˜ì–´ ë²„ë¦¬ë„¤ìš”. useUserì²˜ëŸ¼ ê³µí†µìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ë”°ë¡œ hookì„ ë§Œë“¤ì–´ ë³´ì•˜ìŠµë‹ˆë‹¤.

```javascript
const queryClient = useQueryClient()

const { mutate } = useMutation(api, {
  onSuccess: (res: IResponse<unknown>) => {
    if (callback) callback(res)
    queryClient.invalidateQueries("getUser")
  },
})

return mutate
```

ì´ë ‡ê²Œ APIì™€ ì½œë°± í•¨ìˆ˜ë¥¼ ì¸ìë¡œ ë°›ì•„ ê³µí†µ ì²˜ë¦¬ë¥¼ í•˜ì˜€ë”ë‹ˆ í›¨ì”¬ ê¹”ë”í•˜ê²Œ ì“¸ ìˆ˜ ìˆë„¤ìš”.

```javascript
const updateUser = useUpdateUser(() => UserApi.logout(), afterLogout)
```

í˜¸ì¶œí•˜ëŠ” ê³³ì—ì„œëŠ” ìœ„ì™€ ê°™ì´ ì»´í¬ë„ŒíŠ¸ ìµœìƒìœ„ì— ì„ ì–¸ì„ í•´ ì£¼ê³  ì ì ˆí•œ ì‹œì ì— updateUser()ì„ ë¶ˆëŸ¬ ì£¼ë©´ ë©ë‹ˆë‹¤.

### trouble shooting

React Queryë¥¼ ì ìš©í•˜ë©´ì„œ ì•„ë¬´ ìƒê° ì—†ì´ useMutationì„ useEffectì™€ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ í˜¸ì¶œ ë¶€ë¶„ì— ë„£ì–´ êµ¬í˜„í•˜ì˜€ë”ë‹ˆ ìì£¼ ë³¼ ìˆ˜ ìˆëŠ” invalid hook call ì—ëŸ¬ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤. ì—¬ëŠ hookê³¼ ë§ˆì°¬ê°€ì§€ë¡œ í•¨ìˆ˜í˜• componentì˜ ìµœìƒìœ„ ë¶€ë¶„ì—ì„œ í˜¸ì¶œì„ í•´ì•¼ í•˜ëŠ”ë° ì œê°€ ê·¸ ë¶€ë¶„ì„ ê°„ê³¼í–ˆë˜ ê²ƒì´ì£ . ê·¸ë˜ì„œ ìœ„ ì½”ë“œì™€ ê°™ì´ ì„ ì–¸ì„ í•˜ê³ , useEffect ë‚´ë¶€ë‚˜ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë‚´ë¶€ì—ì„œ `updateUser()` ì„ í˜¸ì¶œí•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ë³€ê²½í•˜ì˜€ë”ë‹ˆ ì—ëŸ¬ê°€ í•´ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.

- ì¶”ê°€ ì´ìŠˆ

V ì»¬ëŸ¬ë§ì€ Native ì•±ì—ì„œ My ë“± ëª‡ ê°€ì§€ í˜ì´ì§€ê°€ ì›¹ë·°ë¡œ êµ¬í˜„ë˜ì–´ ìˆìŠµë‹ˆë‹¤. Reduxë¥¼ ê±·ì–´ë‚´ê³  React Queryë¥¼ ì ìš©í•˜ëŠ” ë™ì•ˆ ì›¹ì—ì„œëŠ” ì´ìŠˆê°€ ì—†ì—ˆìœ¼ë‚˜, ì•± í…ŒìŠ¤íŠ¸ë¥¼ í•´ ë³´ë‹ˆ ì›¹ë·°ë¡œ ë˜ì–´ ìˆëŠ” ë¶€ë¶„ì´ í˜¸ì¶œë  ê²½ìš° user ì •ë³´ë¥¼ ë°›ì•„ ì˜¤ì§€ ëª»í•´ ë¡œê·¸ì¸ í˜ì´ì§€ê°€ ë¡œë”©ë˜ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

ì›ì¸ì„ íŒŒì•…í•´ ë³´ë‹ˆ ì›¹ë·°ê°€ í˜¸ì¶œë  ë•Œ ì•±ì˜ í† í° ì •ë³´ë¥¼ ì‹¤ì–´ ì˜¤ê³  ê·¸ í† í° ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ user ì •ë³´ë¥¼ ê°±ì‹ í•˜ê³  ìˆì—ˆëŠ”ë°ìš”, ì´ ë¶€ë¶„ì„ ëˆ„ë½í•˜ì—¬ user ì •ë³´ë¥¼ ì œëŒ€ë¡œ ë°›ì•„ì˜¤ì§€ ëª»í•˜ëŠ” ê²ƒì´ì—ˆìŠµë‹ˆë‹¤.

ê·¸ë˜ì„œ ì•± ì‹¤í–‰ ì‹œ ìµœì´ˆì— í† í°ì„ ë°›ì•„ ì˜¨ í›„, `prefetchQuery`ë¡œ ë¨¼ì € user ì •ë³´ë¥¼ ë°›ì•„ì˜¤ë„ë¡ í•˜ì˜€ìŠµë‹ˆë‹¤.

```javascript
if (Token.getToken()) {
  queryClient.prefetchQuery("getUser", async () => {
    const [res1, res2] = await Promise.all([
      UserApi.getUser(),
      UserApi.getUserInfo(),
    ])
    if (
      res1.code === StatusCodes.SUCCESS &&
      res2.code === StatusCodes.SUCCESS
    ) {
      return {
        user: res1.data,
        userInfo: res2.data,
      }
    }
    return null
  })
}
```

ê·¸ëŸ°ë° ì´ë ‡ê²Œ í•´ë„ ìƒˆë¡œê³ ì¹¨ì„ í•˜ë©´ ê°„í—ì ìœ¼ë¡œ My í˜ì´ì§€ ì§„ì… ì‹œ user ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í•˜ëŠ” ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì—„ì²­ë‚œ ì‚½ì§ˆ ëì— (ê±°ì˜ 10ì‹œê°„... ë‚ ì•„ê°„ ë¶ˆê¸ˆ ã… ã… ) prefetchQueryë¥¼ í•˜ëŠ” ë¶€ë¶„ì„ ë™ê¸° ì²˜ë¦¬í•˜ì˜€ë”ë‹ˆ ë§ˆì¹¨ë‚´ ì´ìŠˆê°€ í•´ê²°ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ˜Š

```javascript
if (Token.getToken()) {
  await queryClient.prefetchQuery("getUser", async () => {
    const [res1, res2] = await Promise.all([
      UserApi.getUser(),
      UserApi.getUserInfo(),
    ])
    if (
      res1.code === StatusCodes.SUCCESS &&
      res2.code === StatusCodes.SUCCESS
    ) {
      return {
        user: res1.data,
        userInfo: res2.data,
      }
    }
    return null
  })
}
```

(ë°”ë¡œ await í•œ ì¤„ë¡œ ê¹”ë”í•˜ê²Œ í•´ê²°í•˜ì˜€ìŠµë‹ˆë‹¤.)

í† í°ì„ ê°€ì ¸ì˜¤ëŠ” ë¶€ë¶„ë¶€í„° `prefetchQuery`ë¡œ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ê³ , ë§ˆì§€ë§‰ì— ë Œë”ë§ì„ í•˜ëŠ” ê²ƒê¹Œì§€ ëª¨ë‘ await ì²˜ë¦¬ë¥¼ í•˜ì˜€ìŠµë‹ˆë‹¤.

```javascript
try {
  await tryingGetAuth(queryClient)
} finally {
  if (EnvChecker.isDev()) {
    ToastHelper.open(`version: ${VERSION}`)
  }

  // render
  await ReactDOM.render(
    <QueryClientProvider client={queryClient}>
      <BrowserRouter>
        <App />
      </BrowserRouter>
    </QueryClientProvider>,
    rootElement
  )
}
```

### ë§ˆë¬´ë¦¬

ì§€ê¸ˆê¹Œì§€ ì•„ì£¼ ê°„ë‹¨í•˜ê²Œ(?) React Queryë¥¼ ì´ìš©í•˜ì—¬ ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ê³ , ì—…ë°ì´íŠ¸í•˜ëŠ” ë¡œì§ì„ êµ¬í˜„í•´ ë³´ì•˜ìŠµë‹ˆë‹¤. ì•„ì§ê¹Œì§€ëŠ” ëª¨ë“  ë¶€ë¶„ì—ì„œ ì—ëŸ¬ ì—†ì´ ì˜ ë™ì‘í•˜ê³  ë¡œê·¸ì¸ ìœ ì§€ë„ ì˜ ë˜ê³  ìˆë„¤ìš”. ì¶”í›„ì—ëŠ” ë‹¤ë¥¸ APIì—ë„ React Queryë¥¼ ì ìš©í•´ ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.
